package echosentrymiddleware

import (
	"strings"

	"github.com/getsentry/sentry-go"
	"github.com/labstack/echo/v4"
)

func prepareTagValue(str string) string {
	size := 200                              // limit of sentry
	str = strings.ReplaceAll(str, "\n", " ") // no \n in strings
	if len(str) > size {
		return str[:size-3] + "..."
	}

	return str
}

func prepareTagName(str string) string {
	size := 32 // limit of sentry
	if len(str) > size {
		return str[:size]
	}

	return str
}

func setTag(span *sentry.Span, tag, value string) {
	if tag == "" || value == "" {
		return
	}

	span.SetTag(prepareTagName(tag), prepareTagValue(value))
}

func getRequestID(ctx echo.Context) string {
	requestID := ctx.Request().Header.Get(echo.HeaderXRequestID) // request-id generated by reverse-proxy
	if requestID == "" {
		requestID = ctx.Response().Header().Get(echo.HeaderXRequestID) // missed request-id from proxy,
		// got generated one by middleware.RequestID()
	}
	return requestID
}
