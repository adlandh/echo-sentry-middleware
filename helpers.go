package echosentrymiddleware

import (
	"strings"
	"unicode/utf8"

	"github.com/getsentry/sentry-go"
	"github.com/labstack/echo/v5"
)

const (
	// MaxTagNameLength is the maximum length of a Sentry tag name
	MaxTagNameLength = 32
	// MaxTagValueLength is the maximum length of a Sentry tag value
	MaxTagValueLength = 200
)

func limitString(str string, size int) string {
	if size <= 0 {
		return str
	}

	if len(str) <= size {
		return str
	}

	bytes := []byte(str)

	validBytes := bytes[:size]
	for !utf8.Valid(validBytes) {
		validBytes = validBytes[:len(validBytes)-1]
	}

	return string(validBytes)
}

func limitStringWithDots(str string, size int) string {
	const minDotsLimit = 10

	if size <= 0 {
		return str
	}

	if size <= minDotsLimit {
		return limitString(str, size)
	}

	result := limitString(str, size-3)

	if result == str {
		return str
	}

	return result + "..."
}

func prepareTagValue(str string) string {
	str = strings.NewReplacer("\n", " ", "\r", " ", "\t", " ").Replace(str) // no line breaks in tags

	return limitStringWithDots(str, MaxTagValueLength)
}

func prepareTagName(str string) string {
	return limitString(str, MaxTagNameLength)
}

func setTag(span *sentry.Span, tag, value string) {
	if tag == "" || value == "" {
		return
	}

	span.SetTag(prepareTagName(tag), prepareTagValue(value))
}

func getRequestID(ctx *echo.Context) string {
	requestID := ctx.Request().Header.Get(echo.HeaderXRequestID) // request-id generated by reverse-proxy
	if requestID == "" {
		// missed request-id from proxy, got generated one by middleware.RequestID()
		requestID = ctx.Response().Header().Get(echo.HeaderXRequestID)
	}

	return requestID
}
